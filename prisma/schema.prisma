// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../src/generated/prisma"
  binaryTargets = ["native", "rhel-openssl-3.0.x", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccountType {
  CASH
  BANK
  CARD
  E_WALLET
  OTHER
}

enum TxType {
  INCOME
  EXPENSE
  TRANSFER_DEBIT // uang keluar karena transfer
  TRANSFER_CREDIT // uang masuk karena transfer
}

enum BillStatus {
  UNPAID // belum ada pembayaran
  PARTIAL // sudah dibayar sebagian
  PAID // lunas
  OVERDUE // lewat jatuh tempo & belum lunas
}

/**
 * ============================================================
 * USER
 * ============================================================
 */

model User {
  id        String   @id @default(cuid())
  name      String?
  email     String?  @unique
  hashedPin String? // untuk login PIN
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  accounts                 Account[]
  categories               Category[]
  transactions             Transaction[]
  transfers                Transfer[]
  monthlySummaries         MonthlySummary[]
  monthlyCategorySummaries MonthlyCategorySummary[]
  bills                    Bill[]
  categoryBudgets          CategoryBudget[]

  @@index([email])
}

/**
 * ============================================================
 * ACCOUNT
 * ============================================================
 */

model Account {
  id        String      @id @default(cuid())
  userId    String
  name      String
  type      AccountType @default(CASH)
  currency  String      @default("IDR")
  icon      String?
  balance   Int         @default(0) // integer-based for accuracy
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  outgoingTransfers Transfer[] @relation("TransferFrom")
  incomingTransfers Transfer[] @relation("TransferTo")

  @@index([userId])
  @@index([type])
}

/**
 * ============================================================
 * CATEGORY
 * ============================================================
 */

model Category {
  id        String   @id @default(cuid())
  userId    String
  name      String
  isIncome  Boolean  @default(false)
  icon      String?
  createdAt DateTime @default(now())

  user                     User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions             Transaction[]
  monthlyCategorySummaries MonthlyCategorySummary[]
  bills                    Bill[]
  categoryBudgets          CategoryBudget[]

  @@index([userId])
  @@index([isIncome])
}

/**
 * ============================================================
 * TRANSACTION
 * ============================================================
 */

model Transaction {
  id         String   @id @default(cuid())
  userId     String
  accountId  String
  categoryId String?
  amount     Int // always positive
  type       TxType
  note       String?
  occurredAt DateTime @default(now())
  transferId String?
  createdAt  DateTime @default(now())

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  account      Account       @relation(fields: [accountId], references: [id], onDelete: Cascade)
  category     Category?     @relation(fields: [categoryId], references: [id])
  transfer     Transfer?     @relation(fields: [transferId], references: [id], onDelete: Cascade)
  billPayments BillPayment[]

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([transferId])
  @@index([type])
  @@index([occurredAt])
}

/**
 * ============================================================
 * TRANSFER
 * ============================================================
 */

model Transfer {
  id            String   @id @default(cuid())
  userId        String
  fromAccountId String
  toAccountId   String
  amount        Int // always positive
  note          String?
  createdAt     DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  fromAccount Account @relation("TransferFrom", fields: [fromAccountId], references: [id])
  toAccount   Account @relation("TransferTo", fields: [toAccountId], references: [id])

  transactions Transaction[]

  @@index([userId])
  @@index([fromAccountId])
  @@index([toAccountId])
}

/**
 * ============================================================
 * MONTHLY SUMMARIES
 * ============================================================
 */

model MonthlySummary {
  id     String @id @default(cuid())
  userId String
  year   Int
  month  Int // 1–12

  income  Int
  expense Int
  net     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
  @@index([userId, year])
}

/**
 * ============================================================
 * MONTHLY CATEGORY SUMMARIES
 * ============================================================
 */
model MonthlyCategorySummary {
  id     String @id @default(cuid())
  userId String
  year   Int
  month  Int

  categoryId String
  amount     Int
  type       TxType // INCOME / EXPENSE

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id])

  @@unique([userId, year, month, categoryId])
  @@index([userId, year, month])
}

/**
 * ============================================================
 * ANNUAL SUMMARIES
 * ============================================================
 */

model AnnualSummary {
  id     String @id @default(cuid())
  userId String
  year   Int

  income  Int
  expense Int
  net     Int

  expenseRate Float
  savingRate  Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, year])
}

/**
 * ============================================================
 * BILLS
 * ============================================================
 */

model Bill {
  id     String @id @default(cuid())
  userId String

  name        String
  categoryId  String? // expense category
  totalAmount Int // total kewajiban

  dueDate DateTime
  status  BillStatus @default(UNPAID)

  isRecurring Boolean @default(false)
  recurrence  String? // MONTHLY / WEEKLY (future extension)

  note String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category? @relation(fields: [categoryId], references: [id])

  payments BillPayment[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

/**
 * ============================================================
 * BILL PAYMENT
 * ============================================================
 */
model BillPayment {
  id            String @id @default(cuid())
  billId        String
  transactionId String

  amount Int
  paidAt DateTime @default(now())

  bill        Bill        @relation(fields: [billId], references: [id], onDelete: Cascade)
  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([billId])
}

/**
 * ============================================================
 * CATEGORY BUDGET
 * ============================================================
 * Budget pengeluaran berbasis kategori per bulan
 * Tidak mempengaruhi transaksi atau saldo
 */
model CategoryBudget {
  id         String @id @default(cuid())
  userId     String
  categoryId String

  year  Int
  month Int // 1–12

  amount Int // nilai budget (positive integer, IDR-based)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([userId, categoryId, year, month])
  @@index([userId, year, month])
}
